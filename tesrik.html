<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Form Informan</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; max-width: 480px; margin: auto; background: #f9f9f9; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; font-size: 16px; }
    textarea { resize: vertical; }
    img { max-width: 100px; display: block; margin-top: 10px; }
    .komentar { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; box-shadow: 0 0 5px #ccc; }
    .balas-form textarea { margin-top: 10px; }
    .balas-form button { margin-top: 5px; background: #005eff; color: white; border: none; border-radius: 5px; }
    #loginBtn { background: none; border: none; font-size: 24px; cursor: pointer; display: block; margin: 0 auto; }
    #formArea, #komentarArea { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Kirim Informasi</h2>
<div id="formArea">
  <input type="text" id="nama" placeholder="Nama">
  <textarea id="informasi" placeholder="Informasi"></textarea>
  <input type="file" id="file">
  <img id="preview" style="display:none">
  <button onclick="kirim()">Kirim</button>
  <p id="status"></p>
</div>

<button id="loginBtn" onclick="login()">üìù</button>

<div id="komentarArea">
  <h3>Semua Komentar</h3>
  <div id="listKomentar"></div>
</div>

<script>
const URL = 'https://script.google.com/macros/s/AKfycbyftHVscifLH1RtqgXtGpRDsrNsuXbmE6WtjNI37WbfE9ATsjFcvS7YOX9vctTn6Hnk/exec';
let isAdmin = false;

function kirim() {
  const nama = document.getElementById('nama').value.trim();
  const informasi = document.getElementById('informasi').value.trim();
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];

  if (!file) return alert("Pilih file gambar dulu.");

  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    const form = new FormData();
    form.append('nama', nama);
    form.append('informasi', informasi);
    form.append('file', base64);
    form.append('mimeType', file.type);

    fetch(URL, { method: 'POST', body: form })
      .then(r => r.json())
      .then(res => {
        document.getElementById('status').innerText = res.status === "sukses" ? "Berhasil dikirim." : "Gagal: " + res.error;
        if (res.status === "sukses") {
          document.getElementById('nama').value = "";
          document.getElementById('informasi').value = "";
          document.getElementById('file').value = "";
          document.getElementById('preview').style.display = "none";
          loadKomentar();
        }
      });
  };
  reader.readAsDataURL(file);
}

document.getElementById('file').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('preview');
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

function loadKomentar() {
  fetch(URL)
    .then(r => r.json())
    .then(data => {
      let html = '';
      data.reverse().forEach((item, i) => {
        html += `<div class="komentar">
          <b>${item.nama}</b> - ${item.waktu}<br>
          ${item.informasi}<br>
          ${item.foto ? `<a href="${item.foto}" target="_blank"><img src="${item.foto}"></a>` : ''}
          ${item.reply ? `<div style="margin-top:10px;padding:10px;background:#eef;border-radius:5px;"><b>Balasan:</b><br>${item.reply}</div>` : ''}
        `;

        if (isAdmin) {
          const id = 'reply_' + i;
          html += `
            <div class="balas-form">
              <textarea id="${id}" placeholder="Balasan...">${item.reply || ''}</textarea>
              <button onclick="balasKomentar('${item.waktu}', document.getElementById('${id}'))">Kirim</button>
            </div>
          `;
        }

        html += `</div>`;
      });
      document.getElementById('listKomentar').innerHTML = html;
    });
}

function balasKomentar(waktu, textarea) {
  const reply = textarea.value.trim();
  if (!reply) return alert("Isi balasan tidak boleh kosong.");

  fetch(URL, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `waktu=${encodeURIComponent(waktu)}&reply=${encodeURIComponent(reply)}`
  })
  .then(r => r.text())
  .then(res => {
    alert(res);
    loadKomentar();
  });
}

function login() {
  const pw = prompt("Masukkan password admin:");
  if (pw === "0000") {
    isAdmin = true;
    loadKomentar();
  } else {
    alert("Password salah");
  }
}

loadKomentar();
</script>

</body>
</html>
